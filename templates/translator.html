<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translator | BABELANGUE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/static/babelangue_logo.png" alt="Logo" width="40" height="40" class="me-2">
                <span class="fw-bold">BABELANGUE</span>
            </a>
            <div>
                <a class="btn btn-primary me-2" href="/translator">Translator</a>
                <a class="btn btn-outline-primary me-2" href="">Trainer</a>
            </div>
        </div>
    </nav>


    <div class="container mt-5">
        <h1 class="mb-4">Translator</h1>

        <!-- Deck selection -->
        <div class="mb-4">
            <label class="form-label fw-bold">Choose a deck:</label>
            <select class="form-select" id="deckSelect" onchange="loadDeckLanguages()">
                <option value="" selected disabled>Select a deck</option>
                {% for deck in decks %}
                <option value="{{ deck }}">{{ deck }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Display Deck Languages -->
        <div id="deckLangs" class="mb-4"></div>

        <!-- Input text -->
        <div class="mb-4">
            <label class="form-label fw-bold">Text to translate:</label>
            <textarea class="form-control" id="textInput" rows="3" placeholder="Enter text..."></textarea>
        </div>

        <button class="btn btn-primary" onclick="sendTranslation()">Translate</button>
        <button class="btn btn-success ms-2" onclick="saveCard()">Save as Card</button>

        <!-- Results -->
        <div id="results" class="mt-5"></div>
        <div id="saveStatus" class="mt-3"></div>
    </div>

    <script>
        let currentTranslations = null;
        let currentLangs = null;
        let currentDeck = null;

        function loadDeckLanguages() {
            const deck = document.getElementById("deckSelect").value;
            currentDeck = deck;

            fetch(`/get_deck_langs?deck=${deck}`)
                .then(response => response.json())
                .then(data => {
                    currentLangs = data.langs;
                    let html = `<h5>Languages in this deck:</h5><ul class='list-group mt-2'>`;
                    data.langs.forEach(lang => {
                        html += `<li class='list-group-item'>${lang}</li>`;
                    });
                    html += `</ul>`;
                    document.getElementById("deckLangs").innerHTML = html;
                });
        }

        function sendTranslation() {
            const text = document.getElementById("textInput").value;
            const deck = document.getElementById("deckSelect").value;

            if (!text || !deck) {
                alert("Please enter text and select a deck.");
                return;
            }

            fetch("/translate_text", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: text, deck: deck })
            })
                .then(response => response.json())
                .then(data => {
                    const resultsDiv = document.getElementById("results");
                    resultsDiv.innerHTML = "";

                    if (data.error) {
                        resultsDiv.innerHTML = `<div class='alert alert-danger'>${data.error}</div>`;
                        return;
                    }

                    currentTranslations = data.translations;

                    let html = `<h4>Detected source language: <strong>${data.source_lang}</strong></h4><hr>`;
                    html += `<h5>Translations:</h5>`;

                    html += `<ul class='list-group'>`;
                    for (const lang in data.translations) {
                        html += `
          <li class='list-group-item d-flex justify-content-between'>
            <span>${lang}</span>
            <span>${data.translations[lang]}</span>
          </li>`;
                    }
                    html += `</ul>`;

                    resultsDiv.innerHTML = html;
                });
        }

        function saveCard() {
            if (!currentTranslations || !currentDeck) {
                alert("Please translate something before saving.");
                return;
            }

            fetch("/save_card", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ deck: currentDeck, row: currentTranslations })
            })
                .then(response => response.json())
                .then(data => {
                    const saveDiv = document.getElementById("saveStatus");
                    if (data.success) {
                        saveDiv.innerHTML = `<div class='alert alert-success'>Card saved successfully!</div>`;
                    } else {
                        saveDiv.innerHTML = `<div class='alert alert-danger'>${data.error}</div>`;
                    }
                });
        }
    </script>
</body>

</html>